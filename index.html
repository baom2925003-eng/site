import React, { useState } from "react";

interface CalculationRecord {
  id: number;
  emissionFactor: number; // kg / người / năm
  population: number; // người
  totalKg: number;
  totalTon: number;
  regionType: string;
  timestamp: string;
}

const formatNumber = (value: number): string => {
  return value.toLocaleString("vi-VN", {
    maximumFractionDigits: 2,
  });
};

const getRegionLabel = (regionType: string): string => {
  switch (regionType) {
    case "urban":
      return "Khu vực đô thị";
    case "rural":
      return "Khu vực nông thôn";
    case "mixed":
      return "Toàn tỉnh/thành";
    default:
      return "Khác";
  }
};

const HomePage: React.FC = () => {
  const [emissionFactor, setEmissionFactor] = useState<number>(10); // kg/người/năm
  const [population, setPopulation] = useState<number>(100000);
  const [regionType, setRegionType] = useState<string>("urban");
  const [resultKg, setResultKg] = useState<number | null>(null);
  const [resultTon, setResultTon] = useState<number | null>(null);
  const [history, setHistory] = useState<CalculationRecord[]>([]);
  const [validationError, setValidationError] = useState<string | null>(null);
  const [recordId, setRecordId] = useState<number>(1);

  const handlePresetChange = (value: string) => {
    setRegionType(value);

    if (value === "urban") {
      // Ví dụ: Đô thị thường có hệ số phát thải cao hơn
      setEmissionFactor(12);
      setPopulation(200000);
    } else if (value === "rural") {
      setEmissionFactor(7);
      setPopulation(50000);
    } else if (value === "mixed") {
      setEmissionFactor(9);
      setPopulation(150000);
    }
  };

  const handleCalculate = () => {
    if (!Number.isFinite(emissionFactor) || !Number.isFinite(population)) {
      setValidationError("Vui lòng nhập số hợp lệ cho cả hai trường.");
      return;
    }

    if (emissionFactor <= 0) {
      setValidationError("Hệ số phát thải phải lớn hơn 0.");
      return;
    }

    if (population < 0) {
      setValidationError("Dân số không được âm.");
      return;
    }

    setValidationError(null);

    const totalKg = emissionFactor * population;
    const totalTon = totalKg / 1000;

    setResultKg(totalKg);
    setResultTon(totalTon);

    const now = new Date();
    const timestamp = now.toLocaleString("vi-VN", {
      hour12: false,
    });

    const newRecord: CalculationRecord = {
      id: recordId,
      emissionFactor,
      population,
      totalKg,
      totalTon,
      regionType,
      timestamp,
    };

    setRecordId(recordId + 1);
    setHistory((prev) => [newRecord, ...prev].slice(0, 5));
  };

  const handleClearHistory = () => {
    setHistory([]);
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <header className="border-b bg-white">
        <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
            <div>
              <h1 className="text-xl font-semibold text-gray-900">
                Máy tính chất thải điện tử
              </h1>
              <p className="text-sm text-gray-600 mt-1">
                Ước tính nhanh khối lượng rác thải điện tử phát sinh dựa trên dân số
                và hệ số phát thải bình quân đầu người.
              </p>
            </div>
          </div>
        </div>
      </header>

      <main className="flex-1">
        <div className="max-w-5xl mx-auto px-4 py-8 space-y-8">
          {/* Khối giới thiệu ngắn */}
          <section className="bg-white rounded-lg shadow-sm p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-2">
              Thiết kế nhanh cho nhà quản lý môi trường
            </h2>
            <p className="text-sm text-gray-600 mb-2">
              Nhập hệ số phát thải điện tử bình quân đầu người (kg/người/năm) cùng
              với dân số của khu vực, công cụ sẽ tính toán tổng lượng chất thải
              điện tử phát sinh theo năm.
            </p>
            <p className="text-sm text-gray-600">
              Bạn có thể sử dụng các gợi ý theo loại khu vực bên dưới hoặc nhập số
              liệu thực tế của mình.
            </p>
          </section>

          {/* Khu vực form + kết quả */}
          <section className="grid gap-6 md:grid-cols-2">
            {/* Form nhập liệu */}
            <div className="bg-white rounded-lg shadow-sm p-6 space-y-4">
              <h3 className="text-base font-semibold text-gray-900 mb-2">
                1. Nhập dữ liệu đầu vào
              </h3>

              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">
                  Loại khu vực
                </label>
                <select
                  value={regionType}
                  onChange={(e) => handlePresetChange(e.target.value)}
                  className="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                >
                  <option value="urban">Khu vực đô thị (mật độ cao)</option>
                  <option value="rural">Khu vực nông thôn</option>
                  <option value="mixed">Toàn tỉnh/thành (hỗn hợp)</option>
                  <option value="custom">Tùy chỉnh (nhập tay)</option>
                </select>
                <p className="text-xs text-gray-500">
                  Chọn để sử dụng số liệu gợi ý. Bạn vẫn có thể điều chỉnh lại bên
                  dưới.
                </p>
              </div>

              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">
                  Hệ số phát thải bình quân đầu người
                </label>
                <div className="flex items-center space-x-2">
                  <input
                    type="number"
                    min={0}
                    step={0.1}
                    value={Number.isNaN(emissionFactor) ? "" : emissionFactor}
                    onChange={(e) => {
                      const val = parseFloat(e.target.value);
                      if (Number.isNaN(val)) {
                        setEmissionFactor(0);
                      } else {
                        setEmissionFactor(val);
                      }
                    }}
                    className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    placeholder="Ví dụ: 10"
                  />
                  <span className="text-xs text-gray-600 whitespace-nowrap">
                    kg/người/năm
                  </span>
                </div>
                <p className="text-xs text-gray-500">
                  Giá trị trung bình quốc tế thường dao động từ 512 kg/người/năm
                  tùy mức độ phát triển và thói quen sử dụng thiết bị.
                </p>
              </div>

              <div className="space-y-1">
                <label className="block text-sm font-medium text-gray-700">
                  Dân số khu vực
                </label>
                <div className="flex items-center space-x-2">
                  <input
                    type="number"
                    min={0}
                    step={1}
                    value={Number.isNaN(population) ? "" : population}
                    onChange={(e) => {
                      const val = parseInt(e.target.value, 10);
                      if (Number.isNaN(val)) {
                        setPopulation(0);
                      } else {
                        setPopulation(val);
                      }
                    }}
                    className="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                    placeholder="Ví dụ: 100000"
                  />
                  <span className="text-xs text-gray-600 whitespace-nowrap">
                    người
                  </span>
                </div>
              </div>

              {validationError && (
                <div className="rounded-md bg-red-50 border border-red-200 px-3 py-2 text-xs text-red-700">
                  {validationError}
                </div>
              )}

              <button
                type="button"
                onClick={handleCalculate}
                className="mt-2 inline-flex w-full items-center justify-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2"
              >
                Tính toán khối lượng chất thải
              </button>

              <div className="mt-4 rounded-md bg-emerald-50 border border-emerald-100 px-3 py-3">
                <p className="text-xs text-emerald-800">
                  Gợi ý: Hãy sử dụng nguồn số liệu dân số và hệ số phát thải từ các
                  cơ quan thống kê, báo cáo môi trường hoặc nghiên cứu chuyên ngành
                  để có kết quả sát thực tế hơn.
                </p>
              </div>
            </div>

            {/* Kết quả */}
            <div className="bg-white rounded-lg shadow-sm p-6 flex flex-col space-y-4">
              <h3 className="text-base font-semibold text-gray-900 mb-2">
                2. Kết quả ước tính
              </h3>

              <div className="border border-gray-100 rounded-md p-4 bg-gray-50">
                <p className="text-xs text-gray-500 mb-1">Tổng khối lượng/năm</p>
                {resultTon !== null && resultKg !== null ? (
                  <div className="space-y-3">
                    <p className="text-2xl font-semibold text-gray-900">
                      {formatNumber(resultTon)}
                      <span className="ml-1 text-sm font-normal text-gray-600">
                        tấn/năm
                      </span>
                    </p>
                    <p className="text-xs text-gray-600">
                      Tương đương khoảng
                      <span className="font-medium"> {formatNumber(resultKg)}</span>
                      <span className="ml-1">kg rác thải điện tử mỗi năm.</span>
                    </p>
                  </div>
                ) : (
                  <p className="text-sm text-gray-500">
                    Chưa có kết quả. Hãy nhập dữ liệu và bấm "Tính toán" để xem
                    ước tính.
                  </p>
                )}
              </div>

              <div className="grid gap-3 sm:grid-cols-2">
                <div className="border border-gray-100 rounded-md p-3">
                  <p className="text-xs text-gray-500 mb-1">Hệ số phát thải</p>
                  <p className="text-sm font-medium text-gray-900">
                    {formatNumber(emissionFactor)}
                    <span className="ml-1 text-xs font-normal text-gray-600">
                      kg/người/năm
                    </span>
                  </p>
                </div>
                <div className="border border-gray-100 rounded-md p-3">
                  <p className="text-xs text-gray-500 mb-1">Dân số</p>
                  <p className="text-sm font-medium text-gray-900">
                    {formatNumber(population)}
                    <span className="ml-1 text-xs font-normal text-gray-600">
                      người
                    </span>
                  </p>
                </div>
              </div>

              <div className="border border-gray-100 rounded-md p-3">
                <p className="text-xs text-gray-500 mb-1">Thông tin khu vực</p>
                <p className="text-sm text-gray-800">
                  {getRegionLabel(regionType)}
                </p>
              </div>

              <div className="mt-2 border-t border-gray-100 pt-4 space-y-2">
                <div className="flex items-center justify-between">
                  <p className="text-xs font-semibold text-gray-700">
                    Lịch sử các lần tính gần đây
                  </p>
                  {history.length > 0 && (
                    <button
                      type="button"
                      onClick={handleClearHistory}
                      className="text-xs text-gray-500 hover:text-red-600"
                    >
                      Xóa lịch sử
                    </button>
                  )}
                </div>

                {history.length === 0 ? (
                  <p className="text-xs text-gray-500">
                    Mỗi lần tính toán sẽ được lưu lại tại đây để bạn dễ so sánh
                    các kịch bản khác nhau.
                  </p>
                ) : (
                  <ul className="space-y-2 max-h-64 overflow-y-auto pr-1">
                    {history.map((item) => (
                      <li
                        key={item.id}
                        className="border border-gray-100 rounded-md p-3 bg-white"
                      >
                        <div className="flex items-center justify-between mb-1">
                          <p className="text-xs font-medium text-gray-800">
                            {formatNumber(item.totalTon)} tấn/năm
                          </p>
                          <p className="text-[11px] text-gray-500">
                            {item.timestamp}
                          </p>
                        </div>
                        <p className="text-[11px] text-gray-600 mb-1">
                          {getRegionLabel(item.regionType)}  Hệ số: {formatNumber(item.emissionFactor)} kg/người/năm  Dân số: {formatNumber(item.population)} người
                        </p>
                        <p className="text-[11px] text-gray-500">
                          Tổng khối lượng: {formatNumber(item.totalKg)} kg/năm
                        </p>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
          </section>

          {/* Khối giải thích thêm */}
          <section className="bg-white rounded-lg shadow-sm p-6">
            <h3 className="text-base font-semibold text-gray-900 mb-2">
              Gợi ý áp dụng trong thiết kế và quản lý
            </h3>
            <div className="grid gap-4 md:grid-cols-3 text-sm text-gray-700">
              <div className="space-y-1">
                <p className="font-medium text-gray-900">Quy hoạch thu gom</p>
                <p className="text-gray-600 text-xs">
                  Sử dụng kết quả ước tính để bố trí điểm thu gom rác thải điện tử,
                  thiết kế chương trình thu hồi thiết bị cũ theo khu vực.
                </p>
              </div>
              <div className="space-y-1">
                <p className="font-medium text-gray-900">Truyền thông cộng đồng</p>
                <p className="text-gray-600 text-xs">
                  Chuyển đổi khối lượng rác sang con số trực quan giúp nâng cao nhận
                  thức người dân về tầm quan trọng của tái chế và tái sử dụng.
                </p>
              </div>
              <div className="space-y-1">
                <p className="font-medium text-gray-900">Lập báo cáo, đề án</p>
                <p className="text-gray-600 text-xs">
                  Kết hợp số liệu ước tính với dữ liệu thực tế để xây dựng các đề án
                  quản lý chất thải điện tử cấp địa phương hoặc doanh nghiệp.
                </p>
              </div>
            </div>
          </section>
        </div>
      </main>

      <footer className="border-t bg-white mt-8">
        <div className="max-w-5xl mx-auto px-4 py-4 flex flex-col sm:flex-row items-center justify-between space-y-2 sm:space-y-0">
          <p className="text-xs text-gray-500">
            Thiết kế bởi chuyên gia UX/UI cho công cụ tính toán chất thải điện tử.
          </p>
          <p className="text-xs text-gray-400">
            Lưu ý: Kết quả chỉ mang tính ước tính, vui lòng kiểm chứng với số liệu
            chính thức.
          </p>
        </div>
      </footer>
    </div>
  );
};

export default HomePage;
